# Loads default set of integrations. Do not remove.
default_config:

homeassistant:
  customize: !include src/customize.yaml

lovelace:
  mode: yaml
  dashboards: !include src/lovelace/dashboards.yaml
  resources: !include src/lovelace/resources.yaml

frontend:
  themes: !include_dir_merge_named src/frontend/themes

automation: !include src/automations.yaml
script: !include src/scripts.yaml
scene: !include src/scenes.yaml

emulated_hue:
  listen_port: 80
  host_ip: 192.168.1.186
  expose_by_default: false

http:
  use_x_forwarded_for: true
  trusted_proxies:
    - 127.0.0.1

bluetooth:

device_tracker:
  - platform: bluetooth_le_tracker
  - platform: xiaomi
    host: 192.168.0.243
    password: KashtbhanjanDev

tts:
  - platform: google_translate
    language: "en"
    cache: true
    cache_dir: /config/tts
    time_memory: 300

notify:
  - name: bhavya_email
    platform: smtp
    server: smtp.gmail.com
    port: 587
    timeout: 15
    sender: "bhavyarupani@gmail.com"
    encryption: starttls
    username: "bhavyarupani@gmail.com"
    password: !secret gmail_app_password
    recipient:
      - "bhavyarupani@gmail.com"
    sender_name: "Home Assistant"

input_number: !include_dir_merge_named src/helpers
sensor: !include_dir_merge_list src/sensors
utility_meter: !include_dir_merge_named src/utility_meters

template:
  - !include src/sidebar.yaml
  - !include src/templates/electricity.yaml
  - !include src/templates/water.yaml
  - !include src/templates/heating.yaml


rest_command:
  ha_pr_mode_deploy:
    url: "https://api.github.com/repos//bhavyarupani/Home-Assistant-Bhavya/actions/workflows/ha-pr-mode.yml/dispatches"
    method: POST
    headers:
      Authorization: "Bearer !secret github_pat"
      Accept: "application/vnd.github+json"
      Content-Type: "application/json"
    payload: >
      {
        "ref": "master",
        "inputs": {
          "branch": "{{ branch | default('') }}"
        }
      }

  ha_revert_master_now:
    url: "https://api.github.com/repos//bhavyarupani/Home-Assistant-Bhavya/actions/workflows/ha-revert-now.yml/dispatches"
    method: POST
    headers:
      Authorization: "Bearer !secret github_pat"
      Accept: "application/vnd.github+json"
      Content-Type: "application/json"
    payload: >
      { "ref": "master" }

input_text:
  pr_branch_to_test:
    name: PR branch to test
    placeholder: "feat/... or fix/... (empty = latest pushed)"

sensor:
  - platform: file
    name: HA Build Info Raw
    file_path: /config/.ha_build_info

template:
  - sensor:
      - name: HA Build Label
        state: >
          {% set s = states('sensor.ha_build_info_raw') %}
          {% if s in ['unknown','unavailable','none','None',''] %}
            unknown
          {% else %}
            {% set lines = s.split('\n') %}
            {% set d = dict((l.split('=')[0], l.split('=')[1]) for l in lines if '=' in l) %}
            {% if d.get('mode') == 'pr' %}
              PR-{{ d.get('pr_number','?') }} ({{ d.get('branch','') }}) @ {{ d.get('sha','') }}
            {% else %}
              master{% if d.get('tag') %} ({{ d.get('tag') }}){% endif %} @ {{ d.get('sha','') }}
            {% endif %}
          {% endif %}
