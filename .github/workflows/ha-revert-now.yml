name: HA - Revert to master now

on:
  workflow_dispatch:

jobs:
  revert:
    name: Revert HA to master now
    runs-on: self-hosted


    steps:
      - name: SSH into Home Assistant and revert to master
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HA_SSH_HOST }}
          username: ${{ secrets.HA_SSH_USER }}
          key: ${{ secrets.HA_SSH_KEY }}
          port: ${{ secrets.HA_SSH_PORT }}
          script: |
            set -e
            cd /config
            if [ ! -d ".git" ]; then
              echo "ERROR: /config is not a git repo"
              exit 1
            fi

            git fetch --all --prune
            git checkout master
            git reset --hard origin/master

            # write build label file
            SHA="$(git rev-parse --short HEAD)"
            TAG="$(git describe --tags --exact-match 2>/dev/null || true)"
            TS="$(date -Iseconds)"
            cat > /config/.ha_build_info <<EOF
            mode=master
            branch=master
            tag=$TAG
            sha=$SHA
            timestamp=$TS
            EOF

            # restart HA
            ha core restart
