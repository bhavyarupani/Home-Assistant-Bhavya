name: HA PR Mode

on:
  pull_request:
    branches:
      - master
    types:
      - opened
      - reopened
      - synchronize

  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy (feat/* or fix/*). Leave empty = deploy latest updated feat/fix branch."
        required: false
        default: ""

jobs:
  deploy_pr:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy PR branch to Home Assistant (PR mode)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HA_SSH_HOST }}
          port: ${{ secrets.HA_SSH_PORT }}
          username: ${{ secrets.HA_SSH_USER }}
          key: ${{ secrets.HA_SSH_KEY }}
          script: |
            set -e

            cd /config

            # Safety: don't clobber uncommitted edits from File Editor
            if [ -n "$(git status --porcelain)" ]; then
              echo "Uncommitted changes in /config; refusing to switch branches."
              git status --porcelain
              exit 1
            fi

            git fetch origin --prune

            INPUT_BRANCH="${{ github.event.inputs.branch }}"
            PR_BRANCH="${{ github.event.pull_request.head.ref }}"

            if [ -n "$INPUT_BRANCH" ]; then
              BRANCH="$INPUT_BRANCH"
              PR_NUMBER="manual"
            elif [ -n "$PR_BRANCH" ]; then
              BRANCH="$PR_BRANCH"
              PR_NUMBER="${{ github.event.pull_request.number }}"
            else
              BRANCH="$(
                git for-each-ref --sort=-committerdate --format='%(refname:short)' refs/remotes/origin \
                  | grep -E '^origin/(feat|fix)/' \
                  | head -n 1 \
                  | sed 's#^origin/##'
              )"
              PR_NUMBER="auto"
            fi

            if [ -z "$BRANCH" ]; then
              echo "No branch selected/found to deploy."
              exit 1
            fi

            case "$BRANCH" in
              feat/*|fix/*) ;;
              *)
                echo "Refusing to deploy branch '$BRANCH' (not feat/* or fix/*)."
                exit 1
                ;;
            esac

            echo "Deploying branch: $BRANCH (PR_NUMBER=$PR_NUMBER)"

            git checkout -B pr-test "origin/$BRANCH"

            # Update PR-mode heartbeat (watchdog uses this)
            date +%s > /config/.pr_mode_last_push

            # Write build info file so HA UI can display current deployed version
            SHA="$(git rev-parse --short HEAD)"
            TS="$(date -Iseconds)"
            TAG="$(git describe --tags --exact-match 2>/dev/null || true)"

            cat > /config/.ha_build_info <<EOF
            mode=pr
            pr_number=${PR_NUMBER}
            branch=${BRANCH}
            tag=${TAG}
            sha=${SHA}
            timestamp=${TS}
            EOF

            ha core restart
